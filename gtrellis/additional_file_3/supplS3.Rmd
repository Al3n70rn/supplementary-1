Supplementary S3: Produce figure 2 and figure 3 in the main manuscript
==============================================================

**Author**: Zuguang Gu ( z.gu@dkfz.de )

**Date**: `r Sys.Date()`

----------------------------------------

```{r, echo = FALSE, message = FALSE}
suppressWarnings(suppressPackageStartupMessages(library(gtrellis)))
suppressWarnings(suppressPackageStartupMessages(library(ComplexHeatmap)))
```

<style type="text/css">
h1 {
	line-height: 120%;
}
</style>

Load all necessary packages.

```{r}
library(gtrellis)
library(circlize)
library(ComplexHeatmap)
```

## Produce Figure 2

The Differentially methylated data is from Supplementary table 7, Kretzmer H., *et al*. 2015 (http://www.ncbi.nlm.nih.gov/pubmed/26437030). Only the tab "DMRs_BL.GCB" is visualized.

The DMR data is also included in this supplementary (`dmr.txt`). A column which contains 
mean difference of methylation between Burkitt lymphomas and germinal center B cells
is added and a column which represents whether the DMR is hyper-methylated or hypo-methylated is added as well.

DMRs with absolute methylation difference larger than 0.3 are kept for plotting.

```{r}
df = read.table("dmr.txt", header = TRUE, sep = "\t", stringsAsFactors=FALSE)
df = df[, -5]
df$mean_diff = df[[5]] - df[[4]]
df$direction = ifelse(df$mean_diff > 0, "hyper", "hypo")
df = df[abs(df$mean_diff) > 0.3, ]
df = df[, -(4:6)]
head(df)
```

`df` is split into two data frames which contain hyper-methylated DMRs and hypo-methylated DMRs separately.

```{r}
DMR_hyper = df[df$direction == "hyper", ]
DMR_hypo = df[df$direction == "hypo", ]
```

Whole genome is split by 2MB window and `genomeDensity()` from **circlize** package is used
to calculate how much each 2MB window is covered by DMRs.

```{r}
DMR_hyper_density = genomicDensity(DMR_hyper, window.size = 2000000)
DMR_hypo_density = genomicDensity(DMR_hypo, window.size = 2000000)
head(DMR_hyper_density)
```

Maximum density values for both hyper- and hypo-methylated DMRs are calculated as the maximum value on y-axis
in both genomic density tracks.

```{r}
max_density = max(c(DMR_hyper_density[[4]], DMR_hypo_density[[4]]))
```

`rainfallTransform()` from **circlize** package is used to calculate the distance to neighbouring DMRs.

```{r}
DMR_hyper_rainfall = rainfallTransform(DMR_hyper)
DMR_hypo_rainfall = rainfallTransform(DMR_hypo)
head(DMR_hyper_rainfall)
```

Legend is generated by **ComplexHeatmap** package.

```{r}
cm = ColorMapping(levels = c("hyper", "hypo"), colors = c("#FF000080", "#0000FF80"))
lgd = color_mapping_legend(cm, title = "Direction", plot = FALSE)
```

Next we put every thing together and make the plot.

```{r, fig.width = 10, fig.height = 10}
gtrellis_layout(category = paste0("chr", 1:22), n_track = 3, ncol = 4, byrow = FALSE,
    track_axis = TRUE, 
    track_height = c(1, 0.5, 0.5), 
    track_ylim = c(0, 8, 0, max_density, 0, max_density),
    track_ylab = c("log10(dist)", "hyper", "hypo"),
    add_name_track = TRUE, add_ideogram_track = TRUE,
    legend = lgd, title = "Hyper- and hypo-methylated DMRs")

add_points_track(DMR_hyper_rainfall, log10(DMR_hyper_rainfall[[4]]),
    pch = 16, size = unit(0.8, "mm"), gp = gpar(col = "#FF000080"))
add_points_track(DMR_hypo_rainfall, log10(DMR_hypo_rainfall[[4]]), track = current_track(),
    pch = 16, size = unit(0.8, "mm"), gp = gpar(col = "#0000FF80"))

# track for genomic density
add_lines_track(DMR_hyper_density, DMR_hyper_density[[4]], area = TRUE, 
    gp = gpar(fill = "#FF000080", col = NA))
add_lines_track(DMR_hypo_density, DMR_hypo_density[[4]], area = TRUE,
    gp = gpar(fill = "#0000FF80", col = NA))
```

## Produce figure 3

Figure 3 visualizes how well the human genome can be aligned to other species. The pairwise alignment
is downloaded from UCSC Table Browser (http://genome.ucsc.edu/cgi-bin/hgTables). Parameters are as follows:

```
clade: Mammal
genome: Human
assembly: Feb. 2009(GRCh37/hg19)
group: Comparative Genomics
track: Primate Chain/net, Placental Chain/Net, Vertebrate Chain/Net
table: all species that correspond to 'Net'
```

The human genome is segmented by 2MB window and the percentage for 
each window that is covered by aligned regions is calculated.
Processed data is stored in `conservation_to_human.RData`.

```{r}
load("conservation_to_human.RData")
species
head(conservation[, 1:6])
```

Legends are defined by **ComplexHeatmap** package. Here we have three legends corresponding to primates,
placentals and vertebrates.

```{r}
col_fun = list(primate = colorRamp2(c(0, 1), c("white", "red")),
			   placental = colorRamp2(c(0, 1), c("white", "purple")),
			   vertebrate = colorRamp2(c(0, 1), c("white", "orange")))
cm1 = ColorMapping(col_fun = col_fun$primate)
cm2 = ColorMapping(col_fun = col_fun$placental)
cm3 = ColorMapping(col_fun = col_fun$vertebrate)
lgd = list(color_mapping_legend(cm1, title = "Primate", plot = FALSE,
				at = c(0, 0.2, 0.4, 0.6, 0.8, 1), labels = c("0%", "20%", "40%", "60%", "80%", "100%")),
	       color_mapping_legend(cm2, title = "Placental", plot = FALSE,
	       		at = c(0, 0.2, 0.4, 0.6, 0.8, 1), labels = c("0%", "20%", "40%", "60%", "80%", "100%")),
	       color_mapping_legend(cm3, title = "Vertebrate", plot = FALSE,
	       		at = c(0, 0.2, 0.4, 0.6, 0.8, 1), labels = c("0%", "20%", "40%", "60%", "80%", "100%")))
```

Three tracks are created for primate, placental and vertebrate species separatedly.
Heatmaps are used to visualize conservation between species. In the `for` loop, species
are ordered by hierarchical clustering of percentage values that are merged from all chromosomes.
Additionally, the dendrogram which is from clustering is re-ordered so that species that are more similar
to human are put on the top in each heatmap.

```{r, fig.width = 14, fig.height = 14, warning = FALSE}
type_order = c("primate", "placental", "vertebrate")
gtrellis_layout(category = paste0("chr", 1:22), n_track = 3, nrow = 3, compact = TRUE,
    track_height = table(species[, 2])[type_order], track_ylab = type_order,
    add_name_track = TRUE, add_ideogram_track = TRUE,
    track_axis = FALSE, legend = lgd, title = "Pairwise alignment between human and other species")
for(type in type_order) {
	l = species[, 2] == type
	
	m = conservation[, species[l, 1]]
	dend = as.dendrogram(hclust(dist(t(m)), method = "single"))
	dend = stats:::reorder.dendrogram(dend, colSums(m))
	od = order.dendrogram(dend)
	m = m[, od]

	add_heatmap_track(conservation, m, fill = col_fun[[type]])

	add_track(NULL, clip = FALSE, category = "chr22", track = current_track(), panel_fun = function(gr) {
		oxlim = get_cell_meta_data("extended_xlim")
		# to hide the ylab on the right
		grid.rect(x = unit(1, "npc") + unit(1, "mm"), width = unit(1, "cm"), just = "left", 
			gp = gpar(fill = "white", col = "white"))
		
		for(i in seq_len(ncol(m))) {
			grid.text(colnames(m)[i], unit(oxlim[2], "native") + unit(2, "mm"), unit((i-0.5)/ncol(m), "npc"), 
				just = "left", gp = gpar(fontsize = 6))
		}
	})
}
```


## Session info

```{r}
sessionInfo()
```
